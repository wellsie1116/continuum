
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Running Backwards - Continuum</title>
  <meta name="author" content="Kevin Wells">

  
  <meta name="description" content="A Physics Engine Most gaming oriented physics engines focus on one major goal: speed. If a
physics simulation takes too long, then the physics world &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://wellsie1116.github.com/continuum/blog/2012/01/05/running-backwards">
  <link href="/continuum/favicon.png" rel="icon">
  <link href="/continuum/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/continuum/javascripts/modernizr-2.0.js"></script>
  <script src="/continuum/javascripts/ender.js"></script>
  <script src="/continuum/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/continuum/atom.xml" rel="alternate" title="Continuum" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/continuum/">Continuum</a></h1>
  
    <h2>Status updates for my CSSE491 project.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/continuum/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:wellsie1116.github.com/continuum" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/continuum/">Blog</a></li>
  <li><a href="/continuum/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Running Backwards</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-01-05T10:00:00-05:00" pubdate data-updated="true">Jan 5<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>A Physics Engine</h2>

<p>Most gaming oriented physics engines focus on one major goal: speed.  If a
physics simulation takes too long, then the physics world can&#8217;t be updated in
real-time and the whole point of having a physics engine in the game is lost.
Unfortunately, physics engines optimizing for speed can have some drawbacks.</p>

<h3>First Attempt</h3>

<p>Initially, I attempted to use <a href="http://newtondynamics.com/">Newton Dynamics</a> for
my physics engine.  It had nearly all of the features I needed and ran fast as
well.  When I implemented snapshot states of the world, however, the simulation
would output a different result whenever I would jump back in time.  Given that
my simulation has to be deterministic, this engine would not work as is.  After
much tweaking and prodding, I found why the engine would produce
nondeterministic results.  For efficiency, the engine would cache <em>contact
joints</em> from the previous time step to make the computations for the next time
step a bit more efficient.  When I make my snapshots of the physics world, I can
copy all of the information about those contact joints, but I cannot restore
them when I want to jump back to a specific time.  I could simply remove the old
contact joints every frame, but the engine strongly advises
<a href="http://www.newtondynamics.com/wiki/index.php5?title=NewtonInvalidateCache">NOT</a>
to do that.</p>

<h3>Open Dynamics Engine</h3>

<p>Unwilling to cause a significant performance hit to my simulation just to get
deterministic results, I decided to switch engines hoping that the next one I
tried would work better.  I have used <a href="http://ode.org/">ODE</a> in the past and it
worked well, so I thought I would try it.  After switching out the physics
simulation code, I ran the game to find that things still did not run
deterministically.  I was sure that I was capturing all relevant information
from the physics bodies (position, orientation, linear velocity, and angular
velocity).  Force is applied every <em>frame</em>, so that is not a piece of
information that I need to capture.  Again, after a bit of prodding, I found
that ODE uses a random number generator in its simulation.  Fortunately, the
generator allows me to capture and restore its current <em>seed</em>.  I also had to
change how I stored the objects&#8217; orientation.  I initially used a quaternion,
but apparently the engine stores it in matrix form, and the few decimal places
that were lost in the conversions caused the simulation to veer off course.
After making those modifications, I can now simulate a world deterministically,
jumping back in time arbitrarily, and see the same simulation (or a different
one, if I influence the world differently.</p>

<h2>Storing World Snapshots</h2>

<p>After being able to store the world snapshots, I needed a data structure that
can store multiple, ordered snapshots and help with determining how and when to
generate additional snapshots.  While I have not yet fully implemented the
structure, I have identified the main operations I need to perform with it:</p>

<div><script src='https://gist.github.com/1565882.js?file='></script>
<noscript><pre><code>/**
 * Adds a state the ordered set of world states
 * 
 * Preferred structure: Tree
 */
void add(WorldSnapshot* state);

/**
 * Checks if the structure contains a snapshot at the given timestep.
 * 
 * Preferred structure: Tree or Hashtable
 */
bool contains(int timestep);

/**
 * Deletes all snapshots after the given timestep
 * 
 * Preferred structure: Array or List
 */
void purgeAfter(int timestep);

/**
 * Returns the snapshot with a timestep equal
 * to or before the given timestep
 * 
 * Preferred structure: Tree
 */
WorldSnapshot* getClosest(int timestep);

/**
 * Removes all unnecessary snaphots from the structure
 * 
 * Preferred structure: List
 */
void prune(int timestep);
</code></pre></noscript></div>


<p>As you can see by the <strong>Preferred structure</strong> comment, no simple data structure
exists that can efficiently perform all of these operations.  Currently,
however, I only need to use <em>add</em>, <em>purgeAfter</em>, and <em>getClosest</em>, so I have
implemented the structure as a linked list (Dequeue) until I need the additional
functionality.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Kevin Wells</span></span>

      








  


<time datetime="2012-01-05T10:00:00-05:00" pubdate data-updated="true">Jan 5<span>th</span>, 2012</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://wellsie1116.github.com/continuum/blog/2012/01/05/running-backwards/" data-via="" data-counturl="http://wellsie1116.github.com/continuum/blog/2012/01/05/running-backwards/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/continuum/blog/2011/12/16/a-real-framework/" title="Previous Post: A Real Framework">&laquo; A Real Framework</a>
      
      
        <a class="basic-alignment right" href="/continuum/blog/2012/01/08/todo-list/" title="next Post: todo list">todo list &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/continuum/blog/2012/01/26/shadows-and-models/">Shadows and Models</a>
      </li>
    
      <li class="post">
        <a href="/continuum/blog/2012/01/19/adding-a-character/">Adding a Character</a>
      </li>
    
      <li class="post">
        <a href="/continuum/blog/2012/01/08/todo-list/">todo list</a>
      </li>
    
      <li class="post">
        <a href="/continuum/blog/2012/01/05/running-backwards/">Running Backwards</a>
      </li>
    
      <li class="post">
        <a href="/continuum/blog/2011/12/16/a-real-framework/">A Real Framework</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Kevin Wells -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
